<html>
    <head>
        <title>Polychart Test</title>
        <link rel="stylesheet" href="static/tabs.css" type="text/css" media="screen" />
        <script src="js/polychart.standalone.0.0.2.min.js"></script>
    </head>
    <body>
        <div id="graph" ></div>
        <script type="text/javascript">
            var json_url = 'http://localhost:8080/calculate?id=http://formhub.org/education/forms/schooling_status_format_18Nov11/data.csv';
            function makeTitle(slug) {
                    var words = slug.split('_');
                    for(var i = 0; i < words.length; i++) {
                            var word = words[i];
                            words[i] = word.charAt(0).toUpperCase() + word.slice(1);
                    }
                    return words.join(' ');
            }

            d3.json(json_url, function(dataset) {
                /* TODO deal with non-all elements */
                dataset = dataset['(ALL)'];

                var parentGraphDiv = document.getElementById('graph');
                for (var data_key in dataset) {
                data_element = dataset[data_key];
                /* TODO replace using the form schema */
                data_element.titleName = makeTitle(data_element.name);

                    var thisGraphDiv = document.createElement('div');
                    parentGraphDiv.appendChild(thisGraphDiv);
                    
                    var data = data_element.data;
                    var datasize = _.size(data);
                    if(datasize == 0 || data_element.name.charAt(0)=='_') {
                        /*thisGraphDiv.textContent = data_element.titleName + " : 0 responses";*/
                        continue;
                    } else if (datasize == 1) {
                        thisGraphDiv.textContent = data_element.titleName + " : " + _.values(data)[0] + " responses: " + _.keys(data)[0];
                    } else { 
                        var key_val_separated = {'x': _.keys(data), 'y': _.values(data)};
                        if (typeof (key_val_separated.y[0]) === "number") {
                            /* if number make pure histogram */
                            gg.graph(key_val_separated)
                              .layer(gg.layer.bar()
                              .map('x','x').map('y','y'))
                              .opts({'width':'500', 'height':'400',
                                     'padding-right':'90', 'title':data_element.titleName,
                                     'legend-postion':'bottom'})
                              .render(thisGraphDiv);
                        } 
                    }
                };
            });
        </script>
    </body>
</html>
